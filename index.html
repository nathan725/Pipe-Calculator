<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PipeBoss – Final Working Version</title>
<style>
  body{font-family:Arial,sans-serif;margin:0;background:#f1f5f9;height:100vh;display:flex;flex-direction:column;}
  .top{padding:15px;background:#2c3e50;color:white;text-align:center;}
  .top h1{margin:0;font-size:1.4em;}
  .split{flex:1;display:flex;overflow:hidden;}
  .sidebar{width:340px;background:#2c3e50;color:white;padding:15px;overflow-y:auto;}
  .main{flex:1;padding:20px;background:#fff;overflow-y:auto;}
  input,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:none;box-sizing:border-box;}
  input{background:#34495e;color:white;}
  button{background:#3498db;color:white;font-weight:bold;cursor:pointer;}
  button:hover{background:#2980b9;}
  .tree-item{padding:10px 8px;cursor:pointer;border-bottom:1px solid #34495e;position:relative;user-select:none;}
  .project{background:#34495e;font-weight:bold;}
  .job{padding-left:35px;background:#3d566e;}
  .tree-item:hover{background:#4a6785;}
  .active{background:#e67e22 !important;}
  .ctx{position:fixed;background:#111;color:white;padding:8px 0;border-radius:6px;box-shadow:0 4px 15px rgba(0,0,0,.6);z-index:10000;}
  .ctx div{padding:8px 20px;cursor:pointer;white-space:nowrap;}
  .ctx div:hover{background:#3498db;}
  .results{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:20px;}
  .card{padding:18px;border-radius:10px;text-align:center;color:white;font-size:1.3em;}
  .bed{background:#e:#e67e22;}
  .cov{background:#2980b9;}
  .tot{background:#27ae60;grid-column:span 2;}
</style>
</head>
<body>

<div class="top"><h1>PipeBoss Calculator</h1></div>

<div class="split">
  <div class="sidebar">
    <input type="text" id="newProj" placeholder="New project name">
    <button onclick="addProject()">+ Add Project</button>
    <hr style="border-color:#444;margin:20px 0">
    <div id="tree"></div>
  </div>

  <div class="main">
    <h2 id="title">Select or create a job</h2>
    <div style="display:flex;flex-wrap:wrap;gap:20px;">
      <div style="flex:1;min-width:300px;">
        <label>Pipe Diameter (in)</label><input type="number" id="d" step="0.01" value="10.35">
        <label>Trench Width (ft)</label><input type="number" id="w" step="0.1" value="3">
        <label>Bedding Below Invert (ft)</label><input type="number" id="bb" step="0.05" value="0.5">
        <label>Cover Above Crown (ft)</label><input type="number" id="ca" step="0.1" value="0.5">
        <label>Length (ft)</label><input type="number" id="l" step="1" value="89">
        <label>Tons per CY</label><input type="number" id="t" step="0.05" value="1.8">
        <button onclick="saveJob()">Save Job</button>
      </div>
      <div style="flex:1;min-width:350px;background:#f8f9fa;padding:15px;border-radius:8px;">
        <h3>Live Cross-Section</h3>
        <svg id="svg" viewBox="0 0 400 420" style="width:100%;height:380px;background:#fff;border:1px solid #ddd;"></svg>
      </div>
    </div>
    <div class="results" id="results"></div>
  </div>
</div>

<script>
let projects = JSON.parse(localStorage.getItem('pipeBoss2025')) || {};
let curP = null, curJ = null;

function save() { localStorage.setItem('pipeBoss2025', JSON.stringify(projects)); }
function render() {
  const t = document.getElementById('tree'); t.innerHTML = '';
  Object.keys(projects).sort().forEach(p => {
    const pd = document.createElement('div');
    pd.className = 'tree-item project' + (curP===p?' active':'');
    pd.textContent = p;
    pd.onclick = () => { curP = p; curJ = null; document.getElementById('title').textContent = p; render(); calculate(); };
    pd.oncontextmenu = e => menu(e, 'proj', p);
    t.appendChild(pd);

    Object.keys(projects[p]).sort().forEach(j => {
      const jd = document.createElement('div');
      jd.className = 'tree-item job' + (curP===p && curJ===j?' active':'');
      jd.textContent = '└ ' + j;
      jd.onclick = () => loadJob(p, j);
      jd.oncontextmenu = e => menu(e, 'job', p, j);
      t.appendChild(jd);
    });
  });
}

function menu(e, type, p, j=null) {
  e.preventDefault(); e.stopPropagation();
  const old = document.getElementById('ctx');
  if (old) old.remove();

  const m = document.createElement('div');
  m.id = 'ctx'; m.className = 'ctx';
  document.body.appendChild(m);

  const add = (txt, fn) => {
    const d = document.createElement('div');
    d.textContent = txt;
    d.onclick = () => { fn(); m.remove(); };
    m.appendChild(d);
  };

  if (type === 'proj') {
    add('Add New Job', () => {
      const name = prompt('Job name (e.g. 8" Sanitary Sewer):');
      if (name && name.trim()) {
        projects[p][name.trim()] = {d:10.35,w:3,bb:0.5,ca:0.5,l:89,t:1.8};
        curJ = name.trim();
        save(); render(); loadJob(p, curJ);
      }
    });
    add('Rename Project', () => {
      const n = prompt('New project name', p);
      if (n && n !== p) { projects[n] = projects[p]; delete projects[p]; curP = n; save(); render(); }
    });
    add('Delete Project', () => {
      if (confirm('Delete entire project “‘+p+'” and all jobs?')) { delete projects[p]; curP=curJ=null; save(); render(); }
    });
  } else {
    add('Rename Job', () => {
      const n = prompt('New job name', j);
      if (n && n !== j) { projects[p][n] = projects[p][j]; delete projects[p][j]; if(curJ===j) curJ=n; save(); render(); }
    });
    add('Delete Job', () => {
      if (confirm('Delete job “‘+j+'”?')) { delete projects[p][j]; curJ=null; save(); render(); }
    });
  }

  m.style.left = e.pageX + 'px';
  m.style.top = e.pageY + 'px';
}

function addProject() {
  const n = document.getElementById('newProj').value.trim();
  if (!n) return alert('Enter a project name');
  if (projects[n]) return alert('Project already exists');
  projects[n] = {};
  curP = n;
  save();
  document.getElementById('newProj').value = '';
  render();
}

function loadJob(p, j) {
  curP = p; curJ = j;
  const o = projects[p][j];
  ['d','w','bb','ca','l','t'].forEach(id => document.getElementById(id).value = o[id]);
  document.getElementById('title').textContent = p + ' → ' + j;
  calculate();
  render();
}

function saveJob() {
  if (!curP || !curJ) return alert('First select or create a job');
  const o = {d,w,bb,ca,l,t}.reduce((a,id)=>(a[id]=+document.getElementById(id).value,a), {});
  projects[curP][curJ] = o;
  save();
  alert('Job saved!');
}

function calculate() {
  const dIn=+document.getElementById('d').value||0, w=+document.getElementById('w').value||0,
        bb=+document.getElementById('bb').value||0, ca=+document.getElementById('ca').value||0,
        len=+document.getElementById('l').value||0, tcy=+document.getElementById('t').value||1.8;
  const dFt=dIn/12, r=dFt/2, pipeA=Math.PI*r*r;
  const bedH=bb+r, covH=r+ca;
  const bedCY=(w*bedH*len/27)-(pipeA*len/2/27);
  const covCY=(w*covH*len/27)-(pipeA*len/2/27);
  const tot=bedCY+covCY;

  document.getElementById('results').innerHTML=`
    <div class="card bed"><b>BEDDING</b><br>${bedCY.toFixed(2)} CY<br><b>${(bedCY*tcy).toFixed(1)} Tons</b></div>
    <div class="card cov"><b>COVER</b><br>${covCY.toFixed(2)} CY<br><b>${(covCY*tcy).toFixed(1)} Tons</b></div>
    <div class="card tot"><b>TOTAL</b><br>${tot.toFixed(2)} CY • ${(tot*tcy).toFixed(1)} Tons</b></div>
  `;

  const svg=document.getElementById('svg'); svg.innerHTML='';
  const s=80, cx=200, yb=360, totH=bb+dFt+ca;
  svg.innerHTML+=`<rect x="${cx-w*s/2}" y="${yb-totH*s}" width="${w*s}" height="${totH*s}" fill="none" stroke="#333" stroke-width="3"/>`;
  svg.innerHTML+=`<rect x="${cx-w*s/2}" y="${yb-bedH*s}" width="${w*s}" height="${
